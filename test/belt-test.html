<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%; margin: 0; overflow: hidden;">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="importmap">{"imports": {
    "react": "https://esm.sh/stable/react@19.2.0",
    "react-dom/client": "https://esm.sh/stable/react-dom@19.2.0/client"}}
    </script>
    <title>Belt Test</title>
  </head>
  <body style="width: calc(100% - 20px); height: calc(100% - 20px); margin: 10px; overflow: hidden; touch-action: none;">
    <h2 style="font-family: Calibri, sans-serif;">Belt Test</h2>
    <div id="root" style="width: calc(100% - 20px); height: calc(100% - 20px); margin: 0; overflow: auto;"></div>
<script type="module">
import {it, sit, fit, test, assertEqual, assertNotEqual, assertExists, assertNotExists, assertMatch, blueprint, blueprintScrambled} from './test-framework.js';
import {DIRECTION, NAME} from '../entity-properties.js';
const {north, east, south, west} = DIRECTION;

it("creates belt", () => {
  const name = NAME.transportBelt;
  blueprint([
    {name, x: 0, y: 0, direction: north},
  ], ([b1], map) => {
    assertExists(b1);
    assertExists(b1.data.lane);
    assertEqual(map.getEntityAt(0, 0), b1);
    assertMatch(map.getEntitiesIn(0, 0, 1, 1),
        [b1]);
    assertMatch(map.getEntitiesIn(1, 0, 1, 1),
        []);
  });
});
it("splits lane with chunk border", () => {
  const name = NAME.transportBelt;
  blueprintScrambled([
    {name, x: 0, y: -1, direction: north},
    {name, x: 0, y: 0, direction: north},
    {name, x: 0, y: 1, direction: north},
  ], ([b1, b2, b3], map) => {
    assertExists(b1.data.lane);
    assertEqual(b1.data.lane, b3.data.lane);
    map.deleteEntity(b2, 0);
    assertNotEqual(b1.data.lane, b3.data.lane);
    assertNotExists(map.getEntityAt(0, 0));
  });
});
it("T junction behaves correctly", () => {
  const name = NAME.transportBelt;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: north},
    {name, x: -1, y: 0, direction: east},
    {name, x: 1, y: 0, direction: west},
  ], ([b1, b2, b3], map) => {
    assertNotEqual(b1.data.lane, b2.data.lane);
    assertNotEqual(b1.data.lane, b3.data.lane);
    map.deleteEntity(b2, 0);
    assertEqual(b1.data.lane, b3.data.lane);
    assertMatch(b1.data.lane.nodes,
        [{length: 1}, {length: 1}]);
  });
});
it("X junction behaves correctly", () => {
  const name = NAME.transportBelt;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: north},
    {name, x: 0, y: 1, direction: north},
    {name, x: -1, y: 0, direction: east},
    {name, x: 1, y: 0, direction: west},
  ], ([b1, b2, b3, b4], map) => {
    assertEqual(b1.data.lane, b2.data.lane);
    assertNotEqual(b1.data.lane, b3.data.lane);
    assertNotEqual(b1.data.lane, b4.data.lane);
    map.deleteEntity(b3, 0);
    assertNotEqual(b1.data.lane, b4.data.lane);
    map.deleteEntity(b2, 0);
    assertEqual(b1.data.lane, b4.data.lane);
  });
});
it("loop behaves correctly", () => {
  const name = NAME.transportBelt;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: east},
    {name, x: 0, y: 1, direction: north},
    {name, x: 1, y: 1, direction: west},
    {name, x: 1, y: 0, direction: south},
  ], ([b1, b2, b3, b4], map, r) => {
    assertExists(b1.data.lane);
    assertEqual(b1.data.lane, b2.data.lane);
    assertEqual(b1.data.lane, b3.data.lane);
    assertEqual(b1.data.lane, b4.data.lane);
    assertEqual(b1.data.lane.circular, true);
    const b5 = map.createEntity(
        r({name, x: 1, y: -1, direction: south}));
    assertEqual(b1.data.lane.circular, false);
    map.deleteEntity(b5, 0);
    assertEqual(b1.data.lane.circular, true);
    map.deleteEntity(b1, 0);
    assertEqual(b2.data.lane.circular, false);
  });
});
it("connects underground", () => {
  const belt = NAME.transportBelt;
  const name = NAME.undergroundBelt;
  blueprintScrambled([
    {name: belt, x: 0, y: -1, direction: north},
    {name, x: 0, y: 0, direction: north, data: {undergroundUp: true}},
    {name, x: 0, y: 5, direction: north, data: {undergroundUp: false}},
    {name: belt, x: 0, y: 6, direction: north},
  ], ([b1, u1, u2, b2]) => {
    assertEqual(u1.data.beltInput, u2);
    assertExists(u1.data.lane);
    assertEqual(u1.data.lane, u2.data.lane);
    assertMatch(u1.data.lane.nodes,
        [{length: 8}]);
  });
});
it("picks correct underground connection", () => {
  const name = NAME.undergroundBelt;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: north, data: {undergroundUp: true}},
    {name, x: 0, y: 1, direction: north, data: {undergroundUp: true}},
    {name, x: 0, y: 3, direction: north, data: {undergroundUp: false}},
    {name, x: 0, y: 4, direction: north, data: {undergroundUp: false}},
  ], ([u1, u2, u3, u4], map) => {
    assertEqual(u2.data.beltInput, u3);
    assertEqual(u2.data.lane, u3.data.lane);
    assertNotEqual(u1.data.lane, u2.data.lane);
    assertNotEqual(u4.data.lane, u2.data.lane);
    map.deleteEntity(u3, 0);
    assertEqual(u2.data.lane, u4.data.lane);
    map.deleteEntity(u2, 0);
    assertEqual(u1.data.lane, u4.data.lane);
    assertMatch(u1.data.lane.nodes,
        [{length: 5}]);
  });
});
it("considers underground gaps", () => {
  const name = NAME.undergroundBelt;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: north, data: {undergroundUp: true}},
    {name, x: 0, y: 2, direction: north, data: {undergroundUp: false}},
    {name, x: 0, y: 3, direction: north, data: {undergroundUp: true}},
    {name, x: 0, y: 5, direction: north, data: {undergroundUp: false}},
  ], ([u1, u2, u3, u4], map, r) => {
    assertEqual(u1.data.lane, u2.data.lane);
    assertEqual(u1.data.lane, u4.data.lane);
    assertMatch(u1.data.lane.nodes,
        [{length: 6, gaps: [0, 2, 3, 2]}]);
    map.deleteEntity(u4, 0);
    assertMatch(u1.data.lane.nodes,
        [{length: 4, gaps: [1, 2]}]);
    u4 = map.createEntity(
        r({name, x: 0, y: 5, direction: north, data: {undergroundUp: false}}));
    assertMatch(u1.data.lane.nodes,
        [{length: 6, gaps: [0, 2, 3, 2]}]);
    map.deleteEntity(u3, 0);
    assertMatch(u1.data.lane.nodes,
        [{length: 3, gaps: [0, 2]}]);
  });
});
it("considers underground items", () => {
  const belt = NAME.transportBelt;
  const name = NAME.undergroundBelt;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: north, data: {undergroundUp: true}},
    {name: belt, x: 0, y: 1, direction: north},
    {name, x: 0, y: 2, direction: north, data: {undergroundUp: false}},
    {name: belt, x: 0, y: 3, direction: north},
    {name: belt, x: 0, y: -1, direction: north},
  ], ([u1, b1, u2, b2, b3], map, r) => {
    assertMatch(u1.data.lane.nodes,
        [{length: 5, gaps: [1, 2]}]);
    u1.data.lane.minusFlow.push(...new Array(20).fill(0));
    u1.data.lane.minusItems.push(...new Array(20).fill(1));
    map.deleteEntity(u1, 0);
    assertMatch(b2.data.lane.minusFlow,
        {length: 8});
    assertMatch(b3.data.lane.minusFlow,
        new Array(4).fill(0));
    u1 = map.createEntity(
        r({name, x: 0, y: 0, direction: north, data: {undergroundUp: true}}));
    assertMatch(u1.data.lane.minusFlow,
        [0,0,0,0,2,0,0,0,0,0,0,0]);
    u1.data.lane.minusFlow.length = 0;
    u1.data.lane.minusItems.length = 0;
    u1.data.lane.minusFlow.push(...new Array(20).fill(0));
    u1.data.lane.minusItems.push(...new Array(20).fill(1));
    map.deleteEntity(u2, 0);
    u2 = map.createEntity(
        r({name, x: 0, y: 2, direction: north, data: {undergroundUp: false}}));
    assertMatch(u1.data.lane.minusFlow,
        [0,0,0,0,0,0,0,0,2,0,0,0]);
  });
});
it("connects splitter", () => {
  const name = NAME.transportBelt;
  const splitter = NAME.splitter;
  blueprintScrambled([
    {name: splitter, x: 0, y: 0, direction: north},
    {name, x: 0, y: -1, direction: north},
    {name, x: 1, y: -1, direction: north},
    {name, x: 0, y: 1, direction: north},
    {name, x: 1, y: 1, direction: north},
  ], ([s1, b1, b2, b3, b4], map, r) => {
    assertEqual(s1.outputEntities.includes(b1), true);
    assertEqual(s1.data.leftBeltOutput, b1);
    assertExists(s1.data.leftInLane);
    assertEqual(s1.data.leftOutLane, b1.data.lane);
    assertEqual(s1.data.rightOutLane, b2.data.lane);
    assertEqual(s1.data.leftInLane, b3.data.lane);
    assertEqual(s1.data.rightInLane, b4.data.lane);
  }, 0, [0]);
});
it("connects circular splitter", () => {
  const name = NAME.transportBelt;
  const splitter = NAME.splitter;
  blueprintScrambled([
    {name: splitter, x: 0, y: 0, direction: north},
    {name, x: 0, y: -1, direction: west},
    {name, x: -1, y: -1, direction: south},
    {name, x: -1, y: 0, direction: south},
    {name, x: -1, y: 1, direction: east},
    {name, x: 0, y: 1, direction: north},
  ], ([s1, b1, b2, b3, b4, b5], map, r) => {
    assertEqual(b1.data.beltInput, s1);
    assertEqual(b5.data.beltOutput, s1);
    assertEqual(b1.data.lane, b5.data.lane);
    assertEqual(s1.data.leftOutLane, s1.data.leftInLane);
    assertEqual(b1.data.lane.endSplitterData, s1.data);
    assertEqual(b1.data.lane.circular, false);
    map.deleteEntity(b5);
    assertNotEqual(s1.data.leftOutLane, s1.data.leftInLane);
    assertEqual(s1.data.leftBeltInput);
    assertEqual(b4.data.beltOutput);
    assertMatch(s1.data.leftInLane,
        {belts: [s1], nodes:[{length: 1}]});
    assertEqual(s1.data.leftInLane.endSplitterData, s1.data);
    b5 = map.createEntity(
        r({name, x: 0, y: 1, direction: north}));
    assertEqual(s1.data.leftBeltInput, b5);
    assertEqual(b1.data.lane, b5.data.lane);
    assertEqual(s1.data.leftOutLane, s1.data.leftInLane);
  }, 0, [0]);
});
it("connects two splitters", () => {
  const name = NAME.splitter;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: north},
    {name, x: 0, y: -1, direction: north},
  ], ([s1, s2], map, r) => {
    assertEqual(s1.data.leftOutLane, s2.data.leftInLane);
    assertEqual(s1.data.rightOutLane, s2.data.rightInLane);
    map.deleteEntity(s2);
    s2 = map.createEntity(
        r({name, x: 1, y: -1, direction: north}));
    assertEqual(s1.data.rightOutLane, s2.data.leftInLane);
  }, 0, [0]);
});
it("works", () => {
  const name = NAME.transportBelt;
  blueprintScrambled([
    {name, x: 0, y: 0, direction: north},
  ], ([b1]) => {
    assertEqual();
  });
});

test(document.getElementById("root"));
</script>
  </body>
</html>